using FSM;
using UnityEngine;

[CreateAssetMenu(fileName = "PlayerNormalMovementState", menuName = "ScriptableObjects/PlayerNormalMovementState")]
public class PlayerNormalMovementState : StateBase
{
    [SerializeField] private PlayerSharedData PlayerSharedData;
    [SerializeField] private PlayerContainedData PlayerContainedData;
    [SerializeField] private GameEvent pogoPickedUp;
    [SerializeField] private GameEvent AeroplanePickedUp;
    [SerializeField] private GameEvent playerTouchedGround;
    private bool jumpQueued;

    private void OnEnable()
    {
        UnityEngine.SceneManagement.SceneManager.activeSceneChanged += (scene, mode) => { ResetVariable(); };
    }

    private void ResetVariable()
    {
        jumpQueued = false;
        UnSubsribeInputEvents();
    }

    //subscribing all events which can occur during normal state
    private void SubsribeInputEvents()
    {
        PlayerContainedData.InputChannel.SwipeRightOccured.AddListener(SwipedRight);
        PlayerContainedData.InputChannel.SwipeLeftOccured.AddListener(SwipedLeft);
        PlayerContainedData.InputChannel.SwipeUpOccured.AddListener(SwipedUp);
        PlayerContainedData.InputChannel.SwipeDownOccured.AddListener(SwipedDown);
        PlayerContainedData.InputChannel.SingleTapOccured.AddListener(SingleTap);
        PlayerContainedData.InputChannel.DoubleTabOccured.AddListener(DoubleTap);
        pogoPickedUp.TheEvent.AddListener(PogoStick);
        AeroplanePickedUp.TheEvent.AddListener(Aeroplane);
        playerTouchedGround.TheEvent.AddListener(PlayerHasTouchedTheGround);
    }

    //unsubscribing all events which can occur during normal state
    public void UnSubsribeInputEvents()
    {
        PlayerContainedData.InputChannel.SwipeRightOccured.RemoveListener(SwipedRight);
        PlayerContainedData.InputChannel.SwipeLeftOccured.RemoveListener(SwipedLeft);
        PlayerContainedData.InputChannel.SwipeUpOccured.RemoveListener(SwipedUp);
        PlayerContainedData.InputChannel.SwipeDownOccured.RemoveListener(SwipedDown);
        PlayerContainedData.InputChannel.SingleTapOccured.RemoveListener(SingleTap);
        PlayerContainedData.InputChannel.DoubleTabOccured.RemoveListener(DoubleTap);
        pogoPickedUp.TheEvent.RemoveListener(PogoStick);
        AeroplanePickedUp.TheEvent.RemoveListener(Aeroplane);
        playerTouchedGround.TheEvent.RemoveListener(PlayerHasTouchedTheGround);
    }

    //onenter is like start wich will be called once when this state starts
    public override void OnEnter()
    {
        base.OnEnter();
        UnSubsribeInputEvents();
        SubsribeInputEvents();
    }

    //onexit will be called once when state exits
    public override void OnExit()
    {
        UnSubsribeInputEvents();
        base.OnExit();
    }

    //onlogic basically works as update , all work related to update will be done in this method
    public override void OnLogic()
    {
        base.OnLogic();
    }

    //onfixlogic basically works as fixupdate , all work related to fixupdate will be done in this method
    public override void OnFixedLogic()
    {
        base.OnFixedLogic();
        PlayerContainedData.PlayerBasicMovementShared.movement();
    }

    //when swipe right event has occured
    private void SwipedRight()
    {
        PlayerContainedData.PlayerBasicMovementShared.change_lane(1);
    }

    //when swipe left event has occured
    private void SwipedLeft()
    {
        PlayerContainedData.PlayerBasicMovementShared.change_lane(-1);
    }

    //when swipe up event has occured
    private void SwipedUp()
    {
        jumpQueued = !playerRunTimeData.IsGrounded;

        StateMachineEventsSender.SendStateMachineEvent("ToJump");
    
    
    
    }

    //when swipe down event has occured
    private void SwipedDown()
    {
        StateMachineEventsSender.SendStateMachineEvent("ToSlideState");
    }

    //when single tap (Dash) event has occured
    private void SingleTap()
    {
        if (!PlayerSharedData.IsDash && !PlayerSharedData.IsBoosting && !PlayerSharedData.WallRunBuilding && !PlayerSharedData.RotateOnbuilding)
        {
            PlayerContainedData.PlayerBoostState.StartDash();
        }
    }

    //when Double tap (Boost) event has occured
    private void DoubleTap()
    {
        if (!PlayerSharedData.IsBoosting && !PlayerSharedData.WallRunBuilding && !PlayerSharedData.RotateOnbuilding)
        {
            PlayerContainedData.PlayerDoubleBoostState.StartBoost();
        }
    }

    private void PogoStick(GameEvent theEvent)
    {
        // Debug.Log("pogo");
        StateMachineEventsSender.SendStateMachineEvent("ToThurstState");
    }

    private void Aeroplane(GameEvent theEvent)
    {
        //   Debug.Log("ToPlayerAeroplaneState");
        StateMachineEventsSender.SendStateMachineEvent("ToPlayerAeroplaneState");
    }

    public override void OnTriggerEnter(Collider other)
    {
        base.OnTriggerEnter(other);

        PlayerContainedData.PlayerBasicMovementShared.OnTriggerEnter(other);
        if (other.gameObject.tag == ("wallrunbuilding"))
        {
            //  Debug.LogError("wallrun");
            StateMachineEventsSender.SendStateMachineEvent("ToBuildingRunState");
        }
    }

    public override void OnTriggerExit(Collider other)
    {
        base.OnTriggerExit(other);
        PlayerContainedData.PlayerBasicMovementShared.OnTriggerExit(other);
    }

    private void PlayerHasTouchedTheGround(GameEvent gameEvent)
    {
        if(jumpQueued)
        {
            jumpQueued = false;
            StateMachineEventsSender.SendStateMachineEvent("ToJump");
        }
    }
}